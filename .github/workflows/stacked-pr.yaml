name: "Auto Rebase & Retarget Stacked PRs"

on:
  pull_request:
    types: [closed] # Trigger when a PR is closed (merged or not)

jobs:
  rebase-children:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Find child PRs
        run: |
          echo "Parent branch: ${{ github.event.pull_request.head.ref }}"
          # Get PRs whose base == parent branch
          gh pr list \
            --base "${{ github.event.pull_request.head.ref }}" \
            --json number,headRefName \
            > children.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rebase and retarget child branches
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          CHILD_PRS=$(jq -r '.[] | "\(.number):\(.headRefName)"' children.json)

          if [ -z "$CHILD_PRS" ]; then
            echo "‚úÖ No child PRs found."
            exit 0
          fi

          for pr in $CHILD_PRS; do
            NUMBER=${pr%%:*}
            BRANCH=${pr##*:}

            echo "=== Processing PR #$NUMBER ($BRANCH) ==="
            git fetch origin main
            git fetch origin $BRANCH:$BRANCH
            git checkout $BRANCH

            if git rebase origin/main; then
              git push --force-with-lease origin $BRANCH
              echo "‚úÖ Rebased $BRANCH successfully."

              echo "üîÑ Retargeting PR #$NUMBER to base=main"
              gh pr edit $NUMBER --base main
            else
              echo "‚ö†Ô∏è Rebase failed for $BRANCH (PR #$NUMBER). Skipping..."
              git rebase --abort || true
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
